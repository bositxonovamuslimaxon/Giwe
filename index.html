<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GiveawayGenie Pro - Rasmiy Instagram Tanlov Tizimi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
        }

        .ig-gradient {
            background: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C, #FD1D1D);
        }

        .ig-text-gradient {
            background: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C, #FD1D1D);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #E4405F;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .media-select-active {
            border: 4px solid #E4405F;
            transform: scale(0.98);
        }
    </style>
</head>
<body class="text-slate-900">

    <!-- Meta SDK initialization -->
    <div id="fb-root"></div>
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/uz_UZ/sdk.js"></script>

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-md border-bottom border-slate-200">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <a href="#" class="flex items-center gap-2">
                <i class="fas fa-certificate text-2xl ig-text-gradient"></i>
                <span class="text-xl font-extrabold tracking-tight">GiveawayGenie</span>
            </a>
            <div id="auth-indicator" class="text-xs font-semibold text-slate-500 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-slate-300"></span>
                API Ulanmagan
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 py-8">
        
        <!-- Step Indicator -->
        <div class="flex items-center justify-between mb-8 px-2">
            <div class="flex flex-col items-center gap-2">
                <div id="step-1-dot" class="w-8 h-8 rounded-full flex items-center justify-center bg-pink-600 text-white font-bold">1</div>
                <span class="text-[10px] uppercase font-bold text-slate-400">Login</span>
            </div>
            <div class="flex-1 h-[2px] bg-slate-200 mx-4"></div>
            <div class="flex flex-col items-center gap-2">
                <div id="step-2-dot" class="w-8 h-8 rounded-full flex items-center justify-center bg-slate-200 text-slate-400 font-bold">2</div>
                <span class="text-[10px] uppercase font-bold text-slate-400">Post</span>
            </div>
            <div class="flex-1 h-[2px] bg-slate-200 mx-4"></div>
            <div class="flex flex-col items-center gap-2">
                <div id="step-3-dot" class="w-8 h-8 rounded-full flex items-center justify-center bg-slate-200 text-slate-400 font-bold">3</div>
                <span class="text-[10px] uppercase font-bold text-slate-400">G'oliblar</span>
            </div>
        </div>

        <!-- Card: Login -->
        <section id="section-login" class="glass-card rounded-3xl p-8 text-center shadow-xl shadow-slate-200/50">
            <h1 class="text-3xl font-extrabold mb-4">Tanlovni boshlaymiz!</h1>
            <p class="text-slate-500 mb-8 max-w-md mx-auto">Rasmiy Instagram Graph API orqali postingizdagi izohlarni xavfsiz va adolatli tahlil qiling.</p>
            
            <button onclick="loginWithFB()" class="bg-[#1877F2] hover:bg-[#166fe5] text-white font-bold py-4 px-8 rounded-2xl flex items-center justify-center gap-3 w-full sm:w-auto mx-auto transition-all active:scale-95">
                <i class="fab fa-facebook text-xl"></i>
                Facebook orqali kirish
            </button>

            <div class="mt-8 flex items-center justify-center gap-6 text-slate-400 text-sm">
                <div class="flex items-center gap-2"><i class="fas fa-shield-alt"></i> Xavfsiz</div>
                <div class="flex items-center gap-2"><i class="fas fa-check-circle"></i> Rasmiy API</div>
                <div class="flex items-center gap-2"><i class="fas fa-bolt"></i> Tezkor</div>
            </div>
        </section>

        <!-- Card: Select Media -->
        <section id="section-media" class="hidden animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div class="glass-card rounded-3xl p-8 shadow-xl shadow-slate-200/50">
                <h2 class="text-2xl font-extrabold mb-2">Postni tanlang</h2>
                <p class="text-slate-500 mb-6 text-sm">Tanlov o'tkaziladigan professional Instagram postingizni belgilang.</p>
                
                <div id="media-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-8">
                    <!-- Media items will be injected here -->
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">G'oliblar soni</label>
                        <input type="number" id="winners-count" value="1" min="1" max="10" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 focus:ring-2 focus:ring-pink-500 outline-none transition-all">
                    </div>
                    
                    <button id="btn-draw" onclick="processGiveaway()" disabled class="w-full ig-gradient text-white font-extrabold py-5 rounded-2xl shadow-lg shadow-pink-500/20 disabled:opacity-50 disabled:shadow-none transition-all active:scale-95">
                        G'oliblarni aniqlash
                    </button>
                </div>
            </div>
        </section>

        <!-- Card: Results -->
        <section id="section-results" class="hidden space-y-6 animate-in zoom-in-95 duration-700">
            <div class="text-center mb-8">
                <div class="inline-block p-4 bg-yellow-100 rounded-full mb-4">
                    <i class="fas fa-crown text-4xl text-yellow-600"></i>
                </div>
                <h2 class="text-4xl font-black italic">Tabriklaymiz!</h2>
                <p class="text-slate-500 mt-2">Mana bizning tasodifiy g'oliblarimiz:</p>
            </div>

            <div id="winners-list" class="space-y-4">
                <!-- Winners injected here -->
            </div>

            <div id="ai-container" class="hidden glass-card rounded-3xl p-6 border-l-8 border-l-pink-500 shadow-lg">
                <h4 class="font-bold text-pink-600 flex items-center gap-2 mb-2">
                    <i class="fas fa-robot"></i> AI Tahlili
                </h4>
                <p id="ai-response" class="text-slate-700 text-sm leading-relaxed italic"></p>
            </div>

            <button onclick="location.reload()" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl transition-all hover:bg-black">
                Yangi tanlov boshlash
            </button>
        </section>

    </main>

    <!-- Loader Overlay -->
    <div id="loader" class="fixed inset-0 z-[100] bg-white/90 backdrop-blur-sm hidden flex-col items-center justify-center gap-4">
        <div class="spinner"></div>
        <p id="loader-text" class="font-bold text-slate-700">Yuklanmoqda...</p>
    </div>

    <!-- Footer -->
    <footer class="max-w-4xl mx-auto px-4 py-12 text-center">
        <div class="text-[10px] text-slate-400 uppercase tracking-widest font-bold mb-4">Yuridik ma'lumotlar</div>
        <p class="text-xs text-slate-400 leading-loose max-w-2xl mx-auto">
            GiveawayGenie mustaqil loyiha bo'lib, Meta Platforms, Inc. yoki Instagram bilan bog'liq emas. 
            Biz foydalanuvchi parollarini saqlamaymiz. Barcha ma'lumotlar rasmiy API orqali real vaqtda olinadi. 
            &copy; 2026 GiveawayGenie.com
        </p>
    </footer>

    <script>
        // --- KONFIGURATSIYA ---
        const APP_ID = 'YOUR_APP_ID_HERE'; // Meta Developer Dashboard'dan olingan ID ni qo'ying
        const GEMINI_API_KEY = ""; // Gemini API kaliti
        
        let userToken = null;
        let igId = null;
        let selectedMediaId = null;

        // --- SDK INIT ---
        window.fbAsyncInit = function() {
            FB.init({
                appId      : APP_ID,
                cookie     : true,
                xfbml      : true,
                version    : 'v18.0'
            });

            FB.getLoginStatus(res => {
                if (res.status === 'connected') setupAccount(res.authResponse.accessToken);
            });
        };

        // --- LOGIN LOGIKASI ---
        function loginWithFB() {
            FB.login(res => {
                if (res.authResponse) setupAccount(res.authResponse.accessToken);
            }, { scope: 'instagram_basic,instagram_manage_comments,pages_show_list,pages_read_engagement' });
        }

        async function setupAccount(token) {
            userToken = token;
            toggleLoader(true, "Instagram hisobingiz qidirilmoqda...");

            try {
                // 1. Get linked pages
                const pageRes = await fetch(`https://graph.facebook.com/v18.0/me/accounts?access_token=${token}`);
                const pageData = await pageRes.json();
                if (!pageData.data || pageData.data.length === 0) throw new Error("Sizda Facebook sahifa topilmadi.");

                // 2. Get IG Business ID from the first page
                const targetPage = pageData.data[0].id;
                const igRes = await fetch(`https://graph.facebook.com/v18.0/${targetPage}?fields=instagram_business_account&access_token=${token}`);
                const igData = await igRes.json();
                
                if (!igData.instagram_business_account) throw new Error("Sahifaga Instagram Business akkaunti ulanmagan.");
                igId = igData.instagram_business_account.id;

                // UI update
                updateStep(2);
                document.getElementById('section-login').classList.add('hidden');
                document.getElementById('section-media').classList.remove('hidden');
                document.getElementById('auth-indicator').innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500"></span> API Aktiv`;

                loadMedia();
            } catch (err) {
                alert(err.message);
                toggleLoader(false);
            }
        }

        // --- MEDIA YUKLASH ---
        async function loadMedia() {
            try {
                const res = await fetch(`https://graph.facebook.com/v18.0/${igId}/media?fields=id,media_url,thumbnail_url,caption&access_token=${userToken}`);
                const data = await res.json();
                
                const grid = document.getElementById('media-grid');
                grid.innerHTML = data.data.map(item => `
                    <div class="media-card relative group cursor-pointer overflow-hidden rounded-2xl border-2 border-transparent transition-all" onclick="selectPost('${item.id}', this)">
                        <img src="${item.thumbnail_url || item.media_url}" class="w-full h-40 object-cover group-hover:scale-110 transition-transform">
                        <div class="absolute inset-0 bg-black/20 group-hover:bg-black/0 transition-colors"></div>
                    </div>
                `).join('');
            } catch (err) {
                console.error(err);
            } finally {
                toggleLoader(false);
            }
        }

        function selectPost(id, el) {
            selectedMediaId = id;
            document.querySelectorAll('.media-card').forEach(c => c.classList.remove('media-select-active'));
            el.classList.add('media-select-active');
            document.getElementById('btn-draw').disabled = false;
        }

        // --- TANLOVNI O'TKAZISH ---
        async function processGiveaway() {
            const count = parseInt(document.getElementById('winners-count').value);
            toggleLoader(true, "Izohlar tahlil qilinmoqda...");

            try {
                // Fetch comments
                const res = await fetch(`https://graph.facebook.com/v18.0/${selectedMediaId}/comments?fields=from,text&access_token=${userToken}&limit=1000`);
                const data = await res.json();
                const comments = data.data;

                if (!comments || comments.length === 0) throw new Error("Postingizda izohlar mavjud emas.");

                // Pick random winners
                const winners = comments.sort(() => 0.5 - Math.random()).slice(0, count);

                displayWinners(winners);
                await askGemini(winners, comments.length);

            } catch (err) {
                alert(err.message);
            } finally {
                toggleLoader(false);
            }
        }

        function displayWinners(winners) {
            updateStep(3);
            document.getElementById('section-media').classList.add('hidden');
            document.getElementById('section-results').classList.remove('hidden');

            const list = document.getElementById('winners-list');
            list.innerHTML = winners.map((w, i) => `
                <div class="glass-card p-6 rounded-2xl flex items-center justify-between border-b-4 border-slate-200 hover:border-pink-500 transition-all">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 ig-gradient rounded-full flex items-center justify-center text-white font-black">#${i+1}</div>
                        <div>
                            <div class="font-black text-lg">@${w.from?.username || 'foydalanuvchi'}</div>
                            <div class="text-xs text-slate-400 italic">"${w.text}"</div>
                        </div>
                    </div>
                    <i class="fas fa-certificate text-pink-500"></i>
                </div>
            `).join('');
        }

        // --- GEMINI AI INTEGRATSIYA ---
        async function askGemini(winners, total) {
            const prompt = `Instagram tanlovi yakunlandi. Jami izohlar: ${total}. G'oliblar: ${winners.map(w => "@"+w.from?.username).join(', ')}. 
            Ushbu tanlov natijalari bo'yicha quvnoq, tabrik ruhidagi va professional AI audit xulosasini o'zbek tilida yozing. Tanlov adolatli o'tganini ta'kidlang.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const resData = await response.json();
                const text = resData.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    document.getElementById('ai-response').innerText = text;
                    document.getElementById('ai-container').classList.remove('hidden');
                }
            } catch (e) {
                console.error("AI Error:", e);
            }
        }

        // --- YORDAMCHI FUNKSIYALAR ---
        function toggleLoader(show, text = "") {
            const l = document.getElementById('loader');
            document.getElementById('loader-text').innerText = text;
            l.style.display = show ? 'flex' : 'none';
        }

        function updateStep(step) {
            const dots = [1, 2, 3];
            dots.forEach(d => {
                const dot = document.getElementById(`step-${d}-dot`);
                if (d <= step) {
                    dot.className = "w-8 h-8 rounded-full flex items-center justify-center bg-pink-600 text-white font-bold transition-all duration-500";
                }
            });
        }
    </script>
</body>
</html>

